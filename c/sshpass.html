<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>C Code: sshpass工具注解</title>
    <link rel=stylesheet href="site.css">
  </head>
  <body>
    <div class="example" id="sshpass">
      <h2><a href="./">C Code</a>: sshpass工具注解</h2>
	
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cm">/*  This file is part of &quot;sshpass&quot;, a tool for batch running password ssh authentication</span>
<span class="cm"> *  Copyright (C) 2006, 2015 Lingnu Open Source Consulting Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version, provided that it was accepted by</span>
<span class="cm"> *  Lingnu Open Source Consulting Ltd. as an acceptable license for its</span>
<span class="cm"> *  projects. Consult http://www.lingnu.com/licenses.html</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span></pre></div>
          </td>
	  <td class="">
            
          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">#if HAVE_CONFIG_H</span>
<span class="cm">#include &quot;config.h&quot;</span>
<span class="cm">#endif</span>
<span class="cm">*/</span></pre></div>
          </td>
	  <td class="docs">
            <p>注释掉<code>config.h</code></p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cm">/* Define to the version of this package. */</span>
<span class="cp">#define PACKAGE_VERSION &quot;1.06&quot;</span>
<span class="cm">/* Password prompt to use */</span>
<span class="cp">#define PASSWORD_PROMPT &quot;assword&quot;</span>
<span class="cm">/* Define to the full name of this package. */</span>
<span class="cp">#define PACKAGE_NAME &quot;sshpass&quot;</span>
<span class="cm">/* Define to the full name and version of this package. */</span>
<span class="cp">#define PACKAGE_STRING &quot;sshpass 1.06&quot;</span>
<span class="cm">/* Define to 1 if you have the `posix_openpt&#39; function. */</span>
<span class="cp">#define HAVE_POSIX_OPENPT 1</span>

<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#if HAVE_TERMIOS_H</span>
<span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span></pre></div>
          </td>
	  <td class="docs">
            <p>添加必须的宏定义</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">enum</span> <span class="n">program_return_codes</span> <span class="p">{</span>
    <span class="n">RETURN_NOERROR</span><span class="p">,</span>
    <span class="n">RETURN_INVALID_ARGUMENTS</span><span class="p">,</span>
    <span class="n">RETURN_CONFLICTING_ARGUMENTS</span><span class="p">,</span>
    <span class="n">RETURN_RUNTIME_ERROR</span><span class="p">,</span>
    <span class="n">RETURN_PARSE_ERRROR</span><span class="p">,</span>
    <span class="n">RETURN_INCORRECT_PASSWORD</span><span class="p">,</span>
    <span class="n">RETURN_HOST_KEY_UNKNOWN</span><span class="p">,</span>
    <span class="n">RETURN_HOST_KEY_CHANGED</span><span class="p">,</span>
<span class="p">};</span></pre></div>
          </td>
	  <td class="docs">
            <p>定义程序的返回错误编码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cp">#ifndef HAVE_POSIX_OPENPT</span>
<span class="kt">int</span>
<span class="nf">posix_openpt</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ptmx&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">runprogram</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>一些系统没有定义该函数，所以程序自己在这里实现了。</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">struct</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span> <span class="n">PWT_STDIN</span><span class="p">,</span> <span class="n">PWT_FILE</span><span class="p">,</span> <span class="n">PWT_FD</span><span class="p">,</span> <span class="n">PWT_PASS</span> <span class="p">}</span> <span class="n">pwtype</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">pwsrc</span><span class="p">;</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pwprompt</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
<span class="p">}</span> <span class="n">args</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_help</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: &quot;</span> <span class="n">PACKAGE_NAME</span> <span class="s">&quot; [-f|-d|-p|-e] [-hV] command parameters</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -f filename   Take password to use from file</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -d number     Use number as file descriptor for getting password</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -p password   Provide password as argument (security unwise)</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -e            Password is passed as env-var </span><span class="se">\&quot;</span><span class="s">SSHPASS</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   With no parameters - password will be taken from stdin</span><span class="se">\n\n</span><span class="s">&quot;</span>
            <span class="s">&quot;   -P prompt     Which string should sshpass search for to detect a password prompt</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;   -v            Be verbose about what you&#39;re doing</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -h            Show help (this screen)</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;   -V            Print version information</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;At most one of -f, -d, -p or -e should be used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>全局数据结构，保存程序的配置信息</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_options</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>解析命令行参数，将结果填充到<code>args</code>这个全局变量中.成功时，返回<code>argv offset</code>,
失败时，返回一个负数。</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span><span class="o">=</span><span class="n">PWT_STDIN</span><span class="p">;</span>
    <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">fd</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="cp">#define VIRGIN_PWTYPE if( args.pwtype!=PWT_STDIN ) { \</span>
<span class="cp">    fprintf(stderr, &quot;Conflicting password source\n&quot;); \</span>
<span class="cp">    error=RETURN_CONFLICTING_ARGUMENTS; }</span>

    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">opt</span><span class="o">=</span><span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;+f:d:p:P:heVv&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="o">==-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span> <span class="n">opt</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span></pre></div>
          </td>
	  <td class="docs">
            <p>默认密码从标准输入中获取</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">VIRGIN_PWTYPE</span><span class="p">;</span>

	    <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span><span class="o">=</span><span class="n">PWT_FILE</span><span class="p">;</span>
	    <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">filename</span><span class="o">=</span><span class="n">optarg</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span></pre></div>
          </td>
	  <td class="docs">
            <p>从文件中获取密码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">VIRGIN_PWTYPE</span><span class="p">;</span>

	    <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span><span class="o">=</span><span class="n">PWT_FD</span><span class="p">;</span>
	    <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">fd</span><span class="o">=</span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span></pre></div>
          </td>
	  <td class="docs">
            <p>从文件描述符中获取密码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">VIRGIN_PWTYPE</span><span class="p">;</span>

	    <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span><span class="o">=</span><span class="n">PWT_PASS</span><span class="p">;</span>
	    <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">password</span><span class="o">=</span><span class="n">strdup</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>从命令行中获取密码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

                <span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">optarg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
                    <span class="n">optarg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;z&#39;</span><span class="p">;</span>
            <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">pwprompt</span><span class="o">=</span><span class="n">optarg</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">verbose</span><span class="o">++</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span></pre></div>
          </td>
	  <td class="docs">
            <p>为了安全起见，隐藏命令行中的密码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">VIRGIN_PWTYPE</span><span class="p">;</span>

	    <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span><span class="o">=</span><span class="n">PWT_PASS</span><span class="p">;</span>
	    <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">password</span><span class="o">=</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;SSHPASS&quot;</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">password</span><span class="o">==</span><span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;sshpass: -e option given but SSHPASS environment variable not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

                <span class="n">error</span><span class="o">=</span><span class="n">RETURN_INVALID_ARGUMENTS</span><span class="p">;</span>
            <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span>
	<span class="k">case</span> <span class="sc">&#39;:&#39;</span><span class="o">:</span>
	    <span class="n">error</span><span class="o">=</span><span class="n">RETURN_INVALID_ARGUMENTS</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
	    <span class="n">error</span><span class="o">=</span><span class="n">RETURN_NOERROR</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
	    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;(C) 2006-2011 Lingnu Open Source Consulting Ltd.</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;(C) 2015-2016 Shachar Shemesh</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;This program is free software, and can be distributed under the terms of the GPL</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;See the COPYING file for more information.</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;Using </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> as the default password prompt indicator.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PACKAGE_STRING</span><span class="p">,</span> <span class="n">PASSWORD_PROMPT</span> <span class="p">);</span>
	    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">error</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">error</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="k">return</span> <span class="n">optind</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="p">)</span>
<span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>从环境变量<code>SSHPASS</code>中获取密码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">opt_offset</span><span class="o">=</span><span class="n">parse_options</span><span class="p">(</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span> <span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">opt_offset</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>解析命令行参数，填充全局变量<code>args</code></p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">show_help</span><span class="p">();</span>

        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">opt_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// -1 becomes 0, -2 becomes 1 etc.</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">argc</span><span class="o">-</span><span class="n">opt_offset</span><span class="o">&lt;</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">show_help</span><span class="p">();</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>There was some error</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">return</span> <span class="n">runprogram</span><span class="p">(</span> <span class="n">argc</span><span class="o">-</span><span class="n">opt_offset</span><span class="p">,</span> <span class="n">argv</span><span class="o">+</span><span class="n">opt_offset</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handleoutput</span><span class="p">(</span> <span class="kt">int</span> <span class="n">fd</span> <span class="p">);</span>

<span class="cm">/* Global variables so that this information be shared with the signal handler */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ourtty</span><span class="p">;</span> <span class="c1">// Our own tty</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">masterpt</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">window_resize_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">sigchld_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">runprogram</span><span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">winsize</span> <span class="n">ttysize</span><span class="p">;</span> <span class="c1">// The size of our tty</span></pre></div>
          </td>
	  <td class="docs">
            <p>执行ssh命令</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">signal</span><span class="p">(</span> <span class="n">SIGCHLD</span><span class="p">,</span><span class="n">sigchld_handler</span> <span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>We need to interrupt a select with a SIGCHLD. In order to do so, we need a SIGCHLD handler</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">masterpt</span><span class="o">=</span><span class="n">posix_openpt</span><span class="p">(</span><span class="n">O_RDWR</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">masterpt</span><span class="o">==-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to get a pseudo terminal&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RETURN_RUNTIME_ERROR</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>为我们的进程创建 <code>pseudo terminal</code></p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">fcntl</span><span class="p">(</span><span class="n">masterpt</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">O_NONBLOCK</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>设置<code>masterpt</code>的status flag <code>O_NONBLOCK</code></p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span> <span class="n">grantpt</span><span class="p">(</span> <span class="n">masterpt</span> <span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to change pseudo terminal&#39;s permission&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RETURN_RUNTIME_ERROR</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>设置为终端的权限，允许访问slave端</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span> <span class="n">unlockpt</span><span class="p">(</span> <span class="n">masterpt</span> <span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to unlock pseudo terminal&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RETURN_RUNTIME_ERROR</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>unlock a pseudoterminal master/slave pair</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">ourtty</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>打开程序的控制终端</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span> <span class="n">ourtty</span><span class="o">!=-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ioctl</span><span class="p">(</span> <span class="n">ourtty</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttysize</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>设置masterpt终端的大小为ourtty终端的大小</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>        <span class="n">signal</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="n">window_resize_handler</span><span class="p">);</span>

        <span class="n">ioctl</span><span class="p">(</span> <span class="n">masterpt</span><span class="p">,</span> <span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttysize</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>注册信号处理函数 <code>window_resize_handler</code></p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="o">=</span><span class="n">ptsname</span><span class="p">(</span><span class="n">masterpt</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">slavept</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">       Comment no. 3.14159</span>

<span class="cm">       This comment documents the history of code.</span>

<span class="cm">       We need to open the slavept inside the child process, after &quot;setsid&quot;, so that it becomes the controlling</span>
<span class="cm">       TTY for the process. We do not, otherwise, need the file descriptor open. The original approach was to</span>
<span class="cm">       close the fd immediately after, as it is no longer needed.</span>

<span class="cm">       It turns out that (at least) the Linux kernel considers a master ptty fd that has no open slave fds</span>
<span class="cm">       to be unused, and causes &quot;select&quot; to return with &quot;error on fd&quot;. The subsequent read would fail, causing us</span>
<span class="cm">       to go into an infinite loop. This is a bug in the kernel, as the fact that a master ptty fd has no slaves</span>
<span class="cm">       is not a permenant problem. As long as processes exist that have the slave end as their controlling TTYs,</span>
<span class="cm">       new slave fds can be created by opening /dev/tty, which is exactly what ssh is, in fact, doing.</span>

<span class="cm">       Our attempt at solving this problem, then, was to have the child process not close its end of the slave</span>
<span class="cm">       ptty fd. We do, essentially, leak this fd, but this was a small price to pay. This worked great up until</span>
<span class="cm">       openssh version 5.6.</span>

<span class="cm">       Openssh version 5.6 looks at all of its open file descriptors, and closes any that it does not know what</span>
<span class="cm">       they are for. While entirely within its prerogative, this breaks our fix, causing sshpass to either</span>
<span class="cm">       hang, or do the infinite loop again.</span>

<span class="cm">       Our solution is to keep the slave end open in both parent AND child, at least until the handshake is</span>
<span class="cm">       complete, at which point we no longer need to monitor the TTY anyways.</span>
<span class="cm">     */</span>

    <span class="kt">int</span> <span class="n">childpid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">childpid</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>或得伪终端 slave端的名称</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre></pre></div>
          </td>
	  <td class="docs">
            <p>子进程</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">setsid</span><span class="p">();</span></pre></div>
          </td>
	  <td class="docs">
            <p>新建一个会话，并设置进程组ID</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>        <span class="n">slavept</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="p">);</span>
        <span class="n">close</span><span class="p">(</span> <span class="n">slavept</span> <span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>让伪终端slave端成为我们的控制终端,我们不需要一直打开它，所以关闭掉</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">close</span><span class="p">(</span> <span class="n">masterpt</span> <span class="p">);</span>

	<span class="kt">char</span> <span class="o">**</span><span class="n">new_argv</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">new_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">new_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>关闭 伪终端的master端，因为在子进程中不需要它</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">execvp</span><span class="p">(</span> <span class="n">new_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_argv</span> <span class="p">);</span>

	<span class="n">perror</span><span class="p">(</span><span class="s">&quot;sshpass: Failed to run command&quot;</span><span class="p">);</span>

	<span class="n">exit</span><span class="p">(</span><span class="n">RETURN_RUNTIME_ERROR</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">childpid</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">perror</span><span class="p">(</span><span class="s">&quot;sshpass: Failed to create child process&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RETURN_RUNTIME_ERROR</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>在子进程中执行ssh程序</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">slavept</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_NOCTTY</span> <span class="p">);</span>

    <span class="kt">int</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">terminate</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">pid_t</span> <span class="n">wait_id</span><span class="p">;</span>
    <span class="kt">sigset_t</span> <span class="n">sigmask</span><span class="p">,</span> <span class="n">sigmask_select</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>父进程</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigmask_select</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>Set the signal mask during the select</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigmask</span><span class="p">);</span>
    <span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigmask</span><span class="p">,</span> <span class="n">SIGCHLD</span><span class="p">);</span>

    <span class="n">sigprocmask</span><span class="p">(</span> <span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigmask</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>

    <span class="k">do</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">terminate</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">fd_set</span> <span class="n">readfd</span><span class="p">;</span>

	    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readfd</span><span class="p">);</span>
	    <span class="n">FD_SET</span><span class="p">(</span><span class="n">masterpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfd</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>And during the regular run</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="kt">int</span> <span class="n">selret</span><span class="o">=</span><span class="n">pselect</span><span class="p">(</span> <span class="n">masterpt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigmask_select</span> <span class="p">);</span>

	    <span class="k">if</span><span class="p">(</span> <span class="n">selret</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">FD_ISSET</span><span class="p">(</span> <span class="n">masterpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfd</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ret</span><span class="o">=</span><span class="n">handleoutput</span><span class="p">(</span> <span class="n">masterpt</span> <span class="p">))</span> <span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>监听masterpt</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre></pre></div>
          </td>
	  <td class="docs">
            <p>ssh 登录出错</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>                        <span class="k">if</span><span class="p">(</span> <span class="n">ret</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="n">close</span><span class="p">(</span> <span class="n">masterpt</span> <span class="p">);</span> <span class="c1">// Signal ssh that it&#39;s controlling TTY is now closed</span>
                            <span class="n">close</span><span class="p">(</span><span class="n">slavept</span><span class="p">);</span>
                        <span class="p">}</span>

			<span class="n">terminate</span><span class="o">=</span><span class="n">ret</span><span class="p">;</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">terminate</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="n">close</span><span class="p">(</span> <span class="n">slavept</span> <span class="p">);</span>
                        <span class="p">}</span>
		    <span class="p">}</span>
		<span class="p">}</span>
	    <span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>handleoutput 出错时，返回一个正数的错误码</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">wait_id</span><span class="o">=</span><span class="n">waitpid</span><span class="p">(</span> <span class="n">childpid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>判断子进程是否退出，并立即返回</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	    <span class="n">wait_id</span><span class="o">=</span><span class="n">waitpid</span><span class="p">(</span> <span class="n">childpid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">wait_id</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFEXITED</span><span class="p">(</span> <span class="n">status</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">WIFSIGNALED</span><span class="p">(</span> <span class="n">status</span> <span class="p">))</span> <span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">terminate</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span>
	<span class="k">return</span> <span class="n">terminate</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">WIFEXITED</span><span class="p">(</span> <span class="n">status</span> <span class="p">)</span> <span class="p">)</span>
	<span class="k">return</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="k">return</span> <span class="mi">255</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">match</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reference</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span> <span class="p">);</span>
<span class="kt">void</span> <span class="nf">write_pass</span><span class="p">(</span> <span class="kt">int</span> <span class="n">fd</span> <span class="p">);</span>

<span class="kt">int</span> <span class="nf">handleoutput</span><span class="p">(</span> <span class="kt">int</span> <span class="n">fd</span> <span class="p">)</span>
<span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>等待ssh进程退出</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">static</span> <span class="kt">int</span> <span class="n">prevmatch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// If the &quot;password&quot; prompt is repeated, we have the wrong password.</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">firsttime</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">compare1</span><span class="o">=</span><span class="n">PASSWORD_PROMPT</span><span class="p">;</span> <span class="c1">// Asking for a password</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">compare2</span><span class="p">[]</span><span class="o">=</span><span class="s">&quot;The authenticity of host &quot;</span><span class="p">;</span> <span class="c1">// Asks to authenticate host</span></pre></div>
          </td>
	  <td class="docs">
            <p>We are looking for the string</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwprompt</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">compare1</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">pwprompt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="o">&amp;&amp;</span> <span class="n">firsttime</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">firsttime</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SSHPASS searching for password prompt using match </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compare1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">numread</span><span class="o">=</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">numread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SSHPASS read: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">state1</span><span class="o">=</span><span class="n">match</span><span class="p">(</span> <span class="n">compare1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">numread</span><span class="p">,</span> <span class="n">state1</span> <span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>static const char compare3[]=&ldquo;WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!&ldquo;; // Warns about man in the middle attack
The remote identification changed error is sent to stderr, not the tty, so we do not handle it.
This is not a problem, as ssh exists immediately in such a case</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span> <span class="n">compare1</span><span class="p">[</span><span class="n">state1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\0&#39;</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">prevmatch</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="p">)</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SSHPASS detected prompt. Sending password.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">write_pass</span><span class="p">(</span> <span class="n">fd</span> <span class="p">);</span>
	    <span class="n">state1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	    <span class="n">prevmatch</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>Are we at a password prompt?</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="p">)</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SSHPASS detected prompt, again. Wrong password. Terminating.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="n">ret</span><span class="o">=</span><span class="n">RETURN_INCORRECT_PASSWORD</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">ret</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">state2</span><span class="o">=</span><span class="n">match</span><span class="p">(</span> <span class="n">compare2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">numread</span><span class="p">,</span> <span class="n">state2</span> <span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>Wrong password - terminate with proper error code</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span> <span class="n">compare2</span><span class="p">[</span><span class="n">state2</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;\0&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="p">)</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;SSHPASS detected host authentication prompt. Exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">ret</span><span class="o">=</span><span class="n">RETURN_HOST_KEY_UNKNOWN</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>Are we being prompted to authenticate the host?</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">int</span> <span class="nf">match</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reference</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span> <span class="p">)</span>
<span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>如果匹配成功，返回reference的最后一个位置</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">reference</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">bufsize</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">reference</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">==</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
	    <span class="n">state</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">reference</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">==</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
		<span class="n">state</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_pass_fd</span><span class="p">(</span> <span class="kt">int</span> <span class="n">srcfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dstfd</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">write_pass</span><span class="p">(</span> <span class="kt">int</span> <span class="n">fd</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwtype</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">PWT_STDIN</span><span class="p">:</span>
	<span class="n">write_pass_fd</span><span class="p">(</span> <span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">fd</span> <span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PWT_FD</span><span class="p">:</span>
	<span class="n">write_pass_fd</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">fd</span> <span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PWT_FILE</span><span class="p">:</span>
	<span class="p">{</span>
	    <span class="kt">int</span> <span class="n">srcfd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="p">);</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">srcfd</span><span class="o">!=-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">write_pass_fd</span><span class="p">(</span> <span class="n">srcfd</span><span class="p">,</span> <span class="n">fd</span> <span class="p">);</span>
		<span class="n">close</span><span class="p">(</span> <span class="n">srcfd</span> <span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PWT_PASS</span><span class="p">:</span>
	<span class="n">write</span><span class="p">(</span> <span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">password</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">args</span><span class="p">.</span><span class="n">pwsrc</span><span class="p">.</span><span class="n">password</span> <span class="p">)</span> <span class="p">);</span>
	<span class="n">write</span><span class="p">(</span> <span class="n">fd</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>This is a highly simplisic implementation. It&rsquo;s good enough for matching &ldquo;Password: &ldquo;, though.</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span> <span class="nf">write_pass_fd</span><span class="p">(</span> <span class="kt">int</span> <span class="n">srcfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dstfd</span> <span class="p">)</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="n">done</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">done</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numread</span><span class="o">=</span><span class="n">read</span><span class="p">(</span> <span class="n">srcfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">done</span><span class="o">=</span><span class="p">(</span><span class="n">numread</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numread</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
		<span class="n">write</span><span class="p">(</span> <span class="n">dstfd</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
	    <span class="k">else</span>
		<span class="n">done</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">write</span><span class="p">(</span> <span class="n">dstfd</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>读取srcfd中的密码，将其写入dstfd中</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span> <span class="nf">window_resize_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">winsize</span> <span class="n">ttysize</span><span class="p">;</span> <span class="c1">// The size of our tty</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">ioctl</span><span class="p">(</span> <span class="n">ourtty</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttysize</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">ioctl</span><span class="p">(</span> <span class="n">masterpt</span><span class="p">,</span> <span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttysize</span> <span class="p">);</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>信号处理函数，当ourtty的终端大小变化时，同步修改masterpt的终端大小</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span> <span class="nf">sigchld_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div>
          </td>
	  <td class="docs">
            <p>Do nothing handler - makes sure the select will terminate if the signal arrives, though.</p>

          </td>
        </tr>
        
      </table>
      
	<div class="pager">
      
      <p class="prev">
        Prev: <a href="passing-file-descriptors.html">传递文件描述符</a>.
      </p>
      
      
      <p class="next">
        Next: <a href="pty.html">伪终端</a>.
      </p>
      
	</div>
      <p class="footer">
	by <a href="https://github.com/datawolf">@datawolf</a> | <a href="mailto:wanglong@laoqinren.net">联系我</a>
      </p>
    </div>
  </body>
</html>
