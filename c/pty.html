<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>C Code: 伪终端</title>
    <link rel=stylesheet href="site.css">
  </head>
  <body>
    <div class="example" id="pty">
      <h2><a href="./">C Code</a>: 伪终端</h2>
	
      	<div class="summary">
		<h3>pty</h3>

<p>伪终端（pty）是提供双向通信管道的一对虚拟的字符设备。该管道的一端称为<strong>master</strong>，另外一端称为<strong>slave</strong>。</p>

<p>伪终端的slave端更像经典的终端，一般情况下，一个进程可以通过打开伪终端的slave端，将其作为自己的终端，这样的话，拥有伪终端的master端的进程就可以控制该进程。</p>

<p>任何写到伪终端master上东西都会作为salve端进程的输入。例如：向master字符设备写入中断字符（<code>Ctrl+C</code>），连接到slave端的进程就会收到中断信号（SIGINT）。 相反的，任何写到伪终端slave端字符设备的东西都可以被master端的进程读取到。</p>

<p>在master端和slave端的数据量时异步的。</p>

<p>由于历史原因，有两套伪终端的API，<code>BSD-style</code>和 <code>System-V style</code>。<code>System-v style</code> 在linux系统上又称为 UNIX 98 伪终端。在新的应用程序中，我们应该使用Unix 98风格的伪终端。</p>

<h4>Unix 98 pseudoterminals</h4>

<p><code>posix_openpt</code>用来打开下一个可用的伪终端master设备。在伪终端slave设备可使用前，必须设置它的权限，使得应用程序可以访问它。<code>grantpt</code>可以将slave设备的用户ID设置为实际调用者的ID。</p>

<p><code>unlockpt</code>用于准予对伪终端slave设备的访问，从而允许应用程序打开该设备。</p>

<p>在<code>grantpt</code>和<code>unlockpt</code>这两个函数中，文件描述符是与伪终端master设备关联的文件描述符。</p>

<p><code>ptsname</code>函数用于在给定伪终端master设备的文件描述符时，找到伪终端slave设备的路径名。这使应用程序可以独立于给定平台的某种惯例而标识伪终端slave设备。</p>

<p>在linux内核中，系统允许的最大伪终端数目有一个限制，我们可以通过接口<code>/proc/sys/kernel/pty/max</code>动态的调整它，另外，接口<code>/proc/sys/kernel/pty/nr</code>显示了目前系统上正在使用的伪终端数目。</p>

<h4>BSD pseudoterminals</h4>

<p>基于BSD的伪终端中，master设备和slave设备必须提前创建好。主设备为<code>/dev/ptyXY</code>,从设备为<code>/dev/ttyXX</code>。打开伪终端时，我们必须自己确定第一个可用的PTY主设备，为了达到该目的，从<code>/dev/ptyp0</code>开始不断进行尝试，知道成功打开一个可用的PTY主设备。一旦成功打开一个名称为<code>/dev/ptyMN</code>的主设备，那么对应的从设备名称为<code>/dev/ttyMN</code>。</p>

      	</div>
	
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cp">#define _XOPEN_SOURCE</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_noecho</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>	<span class="c1">//turn off echo on slave pty</span>
<span class="kt">void</span>	<span class="nf">do_driver</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>	<span class="c1">//changes our stdin/stdout</span>
<span class="kt">void</span>	<span class="nf">loop</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>		<span class="c1">//copy stdin-&gt;ptym, ptym-&gt;stdout</span>
<span class="kt">int</span> <span class="nf">ptym_open</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pts_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pts_namesz</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fdm</span><span class="p">;</span></pre></div>
          </td>
	  <td class="">
            
          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">strncpy</span><span class="p">(</span><span class="n">pts_name</span><span class="p">,</span> <span class="s">&quot;/dev/ptmx&quot;</span><span class="p">,</span> <span class="n">pts_namesz</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>Return the name of the master device so that on failure
the caller can print an error message.</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">pts_name</span><span class="p">[</span><span class="n">pts_namesz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">fdm</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ptmx&quot;</span><span class="p">,</span> <span class="n">O_RWDR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>Null terminate to handle case where string length &gt; pts_namesz</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">grantpt</span><span class="p">(</span><span class="n">fdm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fdm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>Grant access to slave</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">unlockpt</span><span class="p">(</span><span class="n">fdm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fdm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>clear slave&rsquo;s lock flag</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptsname</span><span class="p">(</span><span class="n">fdm</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fdm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>get slave&rsquo;s name</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">strncpy</span><span class="p">(</span><span class="n">pts_name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">pts_namesz</span><span class="p">);</span>
	<span class="n">pts_name</span><span class="p">[</span><span class="n">pts_namesz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>Return name of slave, NULL terminate to handle case where strlen(pts_name) &gt; pts_namesz</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">return</span> <span class="n">fdm</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ptys_open</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pts_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">fds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fds</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">pts_name</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fds</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">pid_t</span> <span class="nf">pty_fork</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ptrfdm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slave_namesz</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">termios</span> <span class="o">*</span><span class="n">slave_termios</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">winsize</span> <span class="o">*</span><span class="n">slave_winsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fdm</span><span class="p">,</span> <span class="n">fds</span><span class="p">;</span>
	<span class="kt">pid_t</span>	<span class="n">pid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pts_name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fdm</span> <span class="o">=</span> <span class="n">ptym_open</span><span class="p">(</span><span class="n">pts_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pts_name</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;can not open master pty: %s, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pts_name</span><span class="p">,</span> <span class="n">fdm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">slave_name</span><span class="p">,</span> <span class="n">pts_name</span><span class="p">,</span> <span class="n">slave_namesz</span><span class="p">);</span>
		<span class="n">slave_name</span><span class="p">[</span><span class="n">slave_namesz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// child</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setsid</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;setsid error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fds</span> <span class="o">=</span> <span class="n">ptys_open</span><span class="p">(</span><span class="n">pts_name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;can not open slave pty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>return the fd of master</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="n">close</span><span class="p">(</span><span class="n">fdm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">TIOCSCTTY</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;TIOCSCTTY error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>all done with master in child</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">slave_termios</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="n">slave_termios</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcsetattr error on slave pty&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave_winsize</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="n">slave_winsize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;TIOCSWINSZ error on slave pty&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>set slave&rsquo;s termios and window size</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">STDERR_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDERR_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stderr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fds</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span> <span class="o">&amp;&amp;</span> <span class="n">fds</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span> <span class="o">&amp;&amp;</span> <span class="n">fds</span> <span class="o">!=</span> <span class="n">STDERR_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">fds</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>slave becomes stdin/stdout/stderr of child</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// parent</span></pre></div>
          </td>
	  <td class="docs">
            <p>child return 0 just like fork()</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="o">*</span><span class="n">ptrfdm</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>return the fd of master</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">ssize_t</span>             <span class="cm">/* Write &quot;n&quot; bytes to a descriptor  */</span>
<span class="n">writen</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span>		<span class="n">nleft</span><span class="p">;</span>
	<span class="kt">ssize_t</span>		<span class="n">nwritten</span><span class="p">;</span>

	<span class="n">nleft</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nleft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nwritten</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">nleft</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nleft</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
				<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* error, return -1 */</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>      <span class="cm">/* error, return amount written so far */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nleft</span> <span class="o">-=</span> <span class="n">nwritten</span><span class="p">;</span>
		<span class="n">ptr</span>   <span class="o">+=</span> <span class="n">nwritten</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">nleft</span><span class="p">);</span>      <span class="cm">/* return &gt;= 0 */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">tty_raw</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>		<span class="cm">/* put terminal into a raw mode */</span>
<span class="p">{</span>
	<span class="kt">int</span>				<span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">termios</span>	<span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ttystate</span> <span class="o">!=</span> <span class="n">RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">save_termios</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>	<span class="cm">/* structure copy */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Echo off, canonical mode off, extended input</span>
<span class="cm">	 * processing off, signal chars off.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No SIGINT on BREAK, CR-to-NL off, input parity</span>
<span class="cm">	 * check off, don&#39;t strip 8th bit on input, output</span>
<span class="cm">	 * flow control off.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear size bits, parity checking off.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSIZE</span> <span class="o">|</span> <span class="n">PARENB</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set 8 bits/char.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">CS8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Output processing off.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OPOST</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Case B: 1 byte at a time, no timer.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify that the changes stuck.  tcsetattr can return 0 on</span>
<span class="cm">	 * partial success.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_termios</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">))</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">))</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSIZE</span> <span class="o">|</span> <span class="n">PARENB</span> <span class="o">|</span> <span class="n">CS8</span><span class="p">))</span> <span class="o">!=</span> <span class="n">CS8</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;</span> <span class="n">OPOST</span><span class="p">)</span> <span class="o">||</span> <span class="n">buf</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
	  <span class="n">buf</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only some of the changes were made.  Restore the</span>
<span class="cm">		 * original settings.</span>
<span class="cm">		 */</span>
		<span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_termios</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ttystate</span> <span class="o">=</span> <span class="n">RAW</span><span class="p">;</span>
	<span class="n">ttysavefd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">fdm</span><span class="p">,</span><span class="n">c</span><span class="p">,</span> <span class="n">ignoreeof</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">noecho</span><span class="p">,</span> <span class="n">verbose</span><span class="p">;</span>
	<span class="kt">pid_t</span>	<span class="n">pid</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">slave_name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span>	<span class="n">termios</span>	<span class="n">orig_termios</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">winsize</span>	<span class="n">size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;-d:einv&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span> <span class="c1">// driver for stdin/stdout</span>
			<span class="n">driver</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span> <span class="c1">// noecho for slave pty&#39;s line discipline</span>
			<span class="n">noecho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span> <span class="c1">// ignore EOF on standard input</span>
			<span class="n">ignoreeof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span> <span class="c1">// not interactive</span>
			<span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span> <span class="c1">// verbose</span>
			<span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;unrecognized option: -%c&quot;</span><span class="p">,</span> <span class="n">optopt</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&gt;=</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: pty [-d driver -einv] program [arg ...]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>parent returns pid of child</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">interactive</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcgetattr error on stdin&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;TIOCGWINSZ error&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pid</span> <span class="o">=</span> <span class="n">pty_fork</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdm</span><span class="p">,</span> <span class="n">slave_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slave_name</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">pty_fork</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdm</span><span class="p">,</span> <span class="n">slave_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slave_name</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;fork error&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// child</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">noecho</span><span class="p">)</span></pre></div>
          </td>
	  <td class="docs">
            <p>fetch current termios and window size</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>			<span class="n">set_noecho</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">execvp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;can not execute: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;slave name = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slave_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;driver = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interactive</span> <span class="o">&amp;&amp;</span> <span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>stdin is slave pty</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">tty_raw</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;tty_raw error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>user&rsquo;s tty to raw mode</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">atexit</span><span class="p">(</span><span class="n">tty_atexit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;atexit error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>reset user&rsquo;s tty on exit</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">do_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>changes our stdin/stdout</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">loop</span><span class="p">(</span><span class="n">fdm</span><span class="p">,</span> <span class="n">ignoreeof</span><span class="p">);</span>

	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>copyies stdin -&gt;ptym, ptym -&gt; stdout</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">set_noecho</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">termios</span>	<span class="n">stermios</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stermios</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcgetattr error&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stermios</span><span class="p">.</span><span class="n">c_lflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span><span class="o">|</span> <span class="n">ECHOE</span> <span class="o">|</span> <span class="n">ECHOK</span> <span class="o">|</span> <span class="n">ECHONL</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>turn off echo for slave pty</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">stermios</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ONLCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stermios</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcsetattr error&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>also turnoff NL to CR/NL mapping on output</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span>	<span class="n">do_driver</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">pid_t</span>	<span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span></pre></div>
          </td>
	  <td class="docs">
            <p>changes our stdin/stdout</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">pipefd</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;can not create stream pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;fork error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// child</span>
		<span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>
          </td>
	  <td class="docs">
            <p>Create a stream pipe to communicate with the driver</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>stdin for driver</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span> <span class="o">&amp;&amp;</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>stdout for driver</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="n">execlp</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;execlp error for: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>		<span class="c1">// parent</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dup2 error to stdout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">STDIN_FILENO</span> <span class="o">&amp;&amp;</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>leave stderr for driver alone</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">sig_atomic_t</span>	<span class="n">sigcaught</span><span class="p">;</span>		<span class="c1">// set by signal handler</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_term</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sigcaught</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1">// just set flag and return</span>
<span class="p">}</span>

<span class="cp">#define	BUFFSIZE	512</span></pre></div>
          </td>
	  <td class="docs">
            <p>parent returns, but with stdin and stdout conected to the driver</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span>	<span class="nf">loop</span><span class="p">(</span><span class="kt">int</span> <span class="n">ptym</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignoreeof</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">pid_t</span>	<span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">nread</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="n">BUFFSIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;fork error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span> <span class="c1">// child copies stdin to ptym</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFFSIZE</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;read error form stdin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">writen</span><span class="p">(</span><span class="n">ptym</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nread</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;writen error form stdin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>copy stdin-&gt;ptym, ptym-&gt;stdout</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ignoreeof</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kill</span><span class="p">(</span><span class="n">getppid</span><span class="p">(),</span> <span class="n">SIGTERM</span><span class="p">);</span>	<span class="c1">// notify parent</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>we always terminate when we encounter an EOF on stdin.
but we notify the parent only if ignoreeof is 0.</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">struct</span> <span class="n">sigaction</span>	<span class="n">act</span><span class="p">,</span> <span class="n">oact</span><span class="p">;</span>
	<span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sig_term</span><span class="p">;</span>
	<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
	<span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oact</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;sigaction error for SIGTERM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">ptym</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFFSIZE</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// signal caught, error, or EOF</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">writen</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;writen error to stdout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sigcaught</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>Parent copies ptym to stdout</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="p">}</span>

</pre></div>
          </td>
	  <td class="docs">
            <p>Parent returns to caller</p>

          </td>
        </tr>
        
      </table>
      
	<div class="pager">
      
      <p class="prev">
        Prev: <a href="sshpass.html">sshpass工具注解</a>.
      </p>
      
      
      <p class="next">
        Next: <a href="forkptytest.html">伪终端示例程序forkpty</a>.
      </p>
      
	</div>
      <p class="footer">
	by <a href="https://github.com/datawolf">@datawolf</a> | <a href="mailto:wanglong@laoqinren.net">联系我</a>
      </p>
    </div>
  </body>
</html>
