<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>C Code: 伪终端示例程序forkpty</title>
    <link rel=stylesheet href="site.css">
  </head>
  <body>
    <div class="example" id="forkptytest">
      <h2><a href="./">C Code</a>: 伪终端示例程序forkpty</h2>
	
      	<div class="summary">
		<p>该程序利用了<code>-lutil</code>库中的函数<code>forkpty</code>来演示伪终端。</p>

<p>该程序非常简单，它创建了一个伪终端，在子进程中的slave pty中运行bash程序，这样在父进程的master pty就可以对bash进行操作。</p>

<p>该示例程序来自于：《Linux Application Development》 Page 396-400</p>

      	</div>
	
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pty.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;sys/poll.h&gt;</span><span class="cp"></span></pre></div>
          </td>
	  <td class="">
            
          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">volatile</span>  <span class="kt">int</span> <span class="n">sigwinch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>当收到信号SIGWINCH时，改变该值</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="kt">void</span> <span class="nf">sigwinch_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signal</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sigwinch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">winsize</span> <span class="n">ws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">termios</span> <span class="n">ot</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">ufds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#define	BUFSIZE 1024</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span></pre></div>
          </td>
	  <td class="docs">
            <p>信号SIGWINCH处理函数</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;could not get window size&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>获得当前终端的大小</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">forkpty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;forkpty&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>create a new process operating in a pseudoterminal</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
          </td>
	  <td class="docs">
            <p>子进程</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">execl</span><span class="p">(</span><span class="s">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;execl&quot;</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>运行shell</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>从不会运行到这里</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre></pre></div>
          </td>
	  <td class="docs">
            <p>父进程</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sigwinch_handler</span><span class="p">;</span>
	<span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">));</span>
	<span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;could not handl SIGWINCH&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ot</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ot</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICANON</span> <span class="o">|</span> <span class="n">ISIG</span> <span class="o">|</span> <span class="n">ECHO</span><span class="o">|</span> <span class="n">ECHOCTL</span><span class="o">|</span> <span class="n">ECHOE</span> \
			<span class="o">|</span> <span class="n">ECHOK</span><span class="o">|</span> <span class="n">ECHOKE</span><span class="o">|</span> <span class="n">ECHONL</span> <span class="o">|</span> <span class="n">ECHOPRT</span><span class="p">);</span>
	<span class="n">t</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">|=</span> <span class="n">IGNBRK</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span></pre></div>
          </td>
	  <td class="docs">
            <p>注册信号处理函数</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>	<span class="n">ufds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">STDIN_FILENO</span><span class="p">;</span>
	<span class="n">ufds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="n">ufds</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">ufds</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">r</span><span class="p">;</span></pre></div>
          </td>
	  <td class="docs">
            <p>监听父进程的标准输入和伪终端的master端</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="n">r</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">ufds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">))</span>	 <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>监听文件描述符</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">ufds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">|</span> <span class="n">ufds</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">POLLERR</span><span class="o">|</span> <span class="n">POLLHUP</span><span class="o">|</span> <span class="n">POLLNVAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>检测是否达到退出的条件</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">sigwinch</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">perror</span><span class="p">(</span><span class="s">&quot;could not get window size&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">perror</span><span class="p">(</span><span class="s">&quot;could not restore window size&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">sigwinch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>如果需要，改变终端窗口的大小</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
          </td>
	  <td class="docs">
            <p>当伪终端的master端有数据时，读取他，并将它写入父进程的标准输出中</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUFSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">write</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">);</span>

	<span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSANOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ot</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
          </td>
	  <td class="docs">
            <p>当标准输入有数据时，读取它，并将它写入伪终端的master端</p>

          </td>
        </tr>
        
      </table>
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>$ gcc -o forkptytest forkptytest.c -lutil</pre></div>
          </td>
	  <td class="docs">
            <p>编译</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>$ <span class="nb">echo</span> <span class="nv">$$</span>
30690</pre></div>
          </td>
	  <td class="docs">
            <p>查看当前的bash的进程号</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>$ ./forkptytest 
$  <span class="nb">echo</span> <span class="nv">$$</span>
30976
$ uname -a
Linux SZX1000042009 3.13.0-24-generic <span class="c1">#47-Ubuntu SMP Fri May 2 23:30:00 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span></pre></div>
          </td>
	  <td class="docs">
            <p>运行程序，查看bash的进程号，与前面的不同。因为这个bash是在子进程中启动的。</p>

          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>$ <span class="nb">exit</span>
<span class="nb">exit</span>
$ <span class="nb">echo</span> <span class="nv">$$</span>
30690

</pre></div>
          </td>
	  <td class="docs">
            <p>退出bash，并查看进程号，可以看出，我们启动的bash已经退出了。</p>

          </td>
        </tr>
        
      </table>
      
	<div class="pager">
      
      <p class="prev">
        Prev: <a href="pty.html">伪终端</a>.
      </p>
      
      
      <p class="next">
        Next: <a href="ptytest.html">伪终端示例程序ptytest</a>.
      </p>
      
	</div>
      <p class="footer">
	by <a href="https://github.com/datawolf">@datawolf</a> | <a href="mailto:wanglong@laoqinren.net">联系我</a>
      </p>
    </div>
  </body>
</html>
