<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>C Code: 程序自我DEBUG方法</title>
    <link rel=stylesheet href="site.css">
  </head>
  <body>
    <div class="example" id="backtrace">
      <h2><a href="./">C Code</a>: 程序自我DEBUG方法</h2>
	
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&lt;execinfo.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#define BT_BUF_SIZE 100</span>

<span class="kt">void</span> <span class="nf">func3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">[</span><span class="n">BT_BUF_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">strings</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">backtrace</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">BT_BUF_SIZE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;backtrace returned %d addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">strings</span> <span class="o">=</span> <span class="n">backtrace_symbols</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strings</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;backtrace_symbol&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">strings</span><span class="p">);</span>
<span class="p">}</span></pre></div>
          </td>
	  <td class="">
            
          </td>
        </tr>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">func2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">func3</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">ncalls</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncalls</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">func</span><span class="p">(</span><span class="n">ncalls</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">func2</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s num-calls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
          </td>
	  <td class="docs">
            <p>&ldquo;static&rdquo; means don&rsquo;t export the symbol&hellip;</p>

          </td>
        </tr>
        
      </table>
      
      <table>
        
        <tr>
          <td class="code">
            <div class="highlight"><pre>$ gcc -rdynamic -o backtrace backtrace.c
$ ./backtrace 3
backtrace returned <span class="m">8</span> addresses
./backtrace<span class="o">(</span>func3+0x2e<span class="o">)</span> <span class="o">[</span>0x400ae4<span class="o">]</span>
./backtrace<span class="o">()</span> <span class="o">[</span>0x400bb2<span class="o">]</span>
./backtrace<span class="o">(</span>func+0x25<span class="o">)</span> <span class="o">[</span>0x400bda<span class="o">]</span>
./backtrace<span class="o">(</span>func+0x1e<span class="o">)</span> <span class="o">[</span>0x400bd3<span class="o">]</span>
./backtrace<span class="o">(</span>func+0x1e<span class="o">)</span> <span class="o">[</span>0x400bd3<span class="o">]</span>
./backtrace<span class="o">(</span>main+0x59<span class="o">)</span> <span class="o">[</span>0x400c36<span class="o">]</span>

</pre></div>
          </td>
	  <td class="docs">
            <p>The symbol names may be unavailable without the use of special linker
options.  For systems using the GNU linker, it is necessary to use
the -rdynamic linker option.  Note that names of &ldquo;static&rdquo; functions
are not exposed, and won&rsquo;t be available in the backtrace.</p>

          </td>
        </tr>
        
      </table>
      
	<div class="pager">
      
      <p class="prev">
        Prev: <a href="jsmn.html">一个简单的JSON解析程序</a>.
      </p>
      
      
	</div>
      <p class="footer">
	by <a href="https://github.com/0x0916">@0x0916</a> | <a href="mailto:w@laoqinren.net">联系我</a>
      </p>
    </div>
  </body>
</html>
